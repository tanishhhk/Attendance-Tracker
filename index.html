<!DOCTYPE html>
<html ng-app="djuboAttendanceApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Djubo - Attendance Tracker</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.css">
</head>
<body ng-controller="MainController as main">

    <header class="header">
        <div class="header-content">
            <div class="logo">
                <h1>DJUBO</h1>
                <span>Attendance Management</span>
            </div>
            <div class="user-info">
                <div class="user-meta">
                    <span>{{main.currentUser.name}}</span>
                    <span class="user-role">{{main.currentUser.role}}</span>
                    <span class="last-login" ng-if="main.lastLoginDisplay">{{main.lastLoginDisplay}}</span>
                </div>
                <button ng-click="main.openProfile()" class="btn-profile">Profile</button>
                <button ng-click="main.logout()" class="btn-logout">Logout</button>
            </div>
        </div>
    </header>

    <div class="main-container">

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             EMPLOYEE VIEW
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div ng-if="main.currentUser.role === 'employee'" ng-controller="EmployeeController as emp">

            <div class="stats-grid">
                <div class="stat-card"><h3>{{emp.stats.presentDays}}</h3><p>Days Present</p></div>
                <div class="stat-card"><h3>{{emp.stats.absentDays}}</h3><p>Days Absent</p></div>
                <div class="stat-card"><h3>{{emp.stats.lateDays}}</h3><p>Late Arrivals</p></div>
                <div class="stat-card"><h3>{{emp.stats.attendanceRate}}%</h3><p>Attendance Rate</p></div>
            </div>

            <div class="checkin-card">
                <h2>Today's Attendance</h2>
                <div class="current-time">{{emp.currentTime | date:'EEEE, MMMM d, yyyy â€“ HH:mm:ss'}}</div>
                <div class="checkin-status" ng-if="emp.todayStatus.checkIn">
                    <div class="status-row">
                        <span>Check In:</span>
                        <strong>{{emp.todayStatus.checkIn | date:'HH:mm:ss'}} <span class="time-ago">({{emp.checkInFromNow()}})</span></strong>
                    </div>
                    <div class="status-row" ng-if="emp.todayStatus.checkOut">
                        <span>Check Out:</span><strong>{{emp.todayStatus.checkOut | date:'HH:mm:ss'}}</strong>
                    </div>
                    <div class="status-row" ng-if="emp.todayStatus.workDuration">
                        <span>Work Duration:</span><strong>{{emp.todayStatus.workDuration}}</strong>
                    </div>
                    <div class="status-row" ng-if="emp.todayStatus.totalBreakTime">
                        <span>Total Break:</span><strong>{{emp.todayStatus.totalBreakTime}}</strong>
                    </div>
                </div>
                <div class="checkin-actions">
                    <button ng-if="!emp.todayStatus.checkIn" ng-click="emp.checkIn()" class="btn btn-primary">Check In</button>
                    <div ng-if="emp.todayStatus.checkIn && !emp.todayStatus.checkOut" class="action-group">
                        <button ng-if="!emp.onBreak" ng-click="emp.startBreak()" class="btn btn-secondary">Start Break</button>
                        <button ng-click="emp.checkOut()" class="btn btn-primary">Check Out</button>
                    </div>
                    <div ng-if="emp.todayStatus.checkOut" class="completed-msg">âœ“ Attendance marked for today</div>
                </div>
            </div>

            <div class="section-toggle-bar">
                <button ng-click="emp.toggleChart()" class="btn btn-secondary">
                    {{emp.showChart ? 'Hide Analytics' : 'Show Analytics'}}
                </button>
                <button ng-click="emp.openLeaveForm()" class="btn-leave">+ Apply for Leave</button>
            </div>

            <div ng-if="emp.showChart" class="charts-row">
                <div class="chart-card"><div id="attendanceChart" style="height:280px;"></div></div>
                <div class="chart-card"><div id="attendancePie"   style="height:280px;"></div></div>
            </div>

            <div class="calendar-section">
                <div class="calendar-header">
                    <button ng-click="emp.previousMonth()" class="btn-nav">&#8592; Prev</button>
                    <h2>{{emp.calendarMonthDisplay()}}</h2>
                    <button ng-click="emp.nextMonth()" class="btn-nav">Next &#8594;</button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day header" ng-repeat="d in emp.weekDays">{{d}}</div>
                    <div class="calendar-day"
                         ng-repeat="day in emp.calendarDays"
                         title="{{day.tooltip}}"
                         ng-class="{'other-month':!day.isCurrentMonth,'today':day.isToday,
                                    'present':day.status==='present','absent':day.status==='absent',
                                    'late':day.status==='late','on-leave':day.status==='on-leave'}">
                        {{day.date}}
                    </div>
                </div>
                <div class="calendar-legend">
                    <span><span class="dot present"></span> Present</span>
                    <span><span class="dot late"></span> Late</span>
                    <span><span class="dot absent"></span> Absent</span>
                    <span><span class="dot on-leave"></span> On Leave</span>
                </div>
            </div>

            <div class="activity-section" ng-if="emp.recentActivity.length > 0">
                <h3>Recent Activity</h3>
                <ul class="activity-list">
                    <li ng-repeat="a in emp.recentActivity">
                        <span class="activity-date">{{a.date}}</span>
                        <span class="activity-text">{{a.text}}</span>
                    </li>
                </ul>
            </div>

            <div class="leave-history-section" ng-if="emp.myLeaves.length > 0">
                <h3>My Leave Requests</h3>
                <table class="leave-table">
                    <thead><tr><th>Type</th><th>From</th><th>To</th><th>Days</th><th>Reason</th><th>Applied</th><th>Status</th></tr></thead>
                    <tbody>
                        <tr ng-repeat="l in emp.myLeaves | orderBy:'-appliedOn'">
                            <td>{{l.type}}</td><td>{{l.fromDate}}</td><td>{{l.toDate}}</td>
                            <td>{{l.days}}</td><td class="reason-cell">{{l.reason}}</td>
                            <td>{{l.appliedOn | date:'MMM d, HH:mm'}}</td>
                            <td><span ng-class="emp.leaveStatusClass(l.status)">{{l.status}}</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Leave application modal -->
            <div class="modal" ng-if="emp.showLeaveForm" ng-click="emp.closeLeaveForm()">
                <div class="modal-content leave-modal" ng-click="$event.stopPropagation()">
                    <div class="modal-header">
                        <h2>Apply for Leave</h2>
                        <button ng-click="emp.closeLeaveForm()" class="btn-close">Close</button>
                    </div>
                    <div class="form-group">
                        <label>Leave Type</label>
                        <select ng-model="emp.leaveForm.type" required>
                            <option value="">-- Select Type --</option>
                            <option ng-repeat="t in emp.leaveTypes" value="{{t}}">{{t}}</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>From Date</label><input type="date" ng-model="emp.leaveForm.fromDate"></div>
                        <div class="form-group"><label>To Date</label><input type="date" ng-model="emp.leaveForm.toDate"></div>
                    </div>
                    <div class="form-group">
                        <label>Reason</label>
                        <textarea ng-model="emp.leaveForm.reason" rows="3" placeholder="Briefly describe the reason..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button ng-click="emp.submitLeave()" class="btn btn-primary">Submit Request</button>
                        <button ng-click="emp.closeLeaveForm()" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>

        </div><!-- /employee -->


        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             ADMIN VIEW
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div ng-if="main.currentUser.role === 'admin'" ng-controller="AdminController as admin">

            <div class="stats-grid">
                <div class="stat-card"><h3>{{admin.stats.totalEmployees}}</h3><p>Total Employees</p></div>
                <div class="stat-card"><h3>{{admin.stats.presentToday}}</h3><p>Present Today</p></div>
                <div class="stat-card"><h3>{{admin.stats.absentToday}}</h3><p>Absent Today</p></div>
                <div class="stat-card"><h3>{{admin.stats.lateToday}}</h3><p>Late Today</p></div>
            </div>

            <div class="admin-tabs">
                <button class="tab-btn" ng-class="{'tab-active': admin.activeTab==='attendance'}" ng-click="admin.activeTab='attendance'">
                    Attendance
                </button>
                <button class="tab-btn" ng-class="{'tab-active': admin.activeTab==='leaves'}" ng-click="admin.activeTab='leaves'">
                    Leave Requests
                    <span class="leave-badge" ng-if="admin.pendingLeavesCount > 0">{{admin.pendingLeavesCount}}</span>
                </button>
                <button class="tab-btn" ng-class="{'tab-active': admin.activeTab==='add'}" ng-click="admin.activeTab='add'">
                    + Add Employee
                </button>
            </div>

            <!-- â”€â”€ Attendance Tab â”€â”€ -->
            <div ng-if="admin.activeTab === 'attendance'">
                <div class="section-toggle-bar">
                    <button ng-click="admin.toggleCharts()" class="btn btn-secondary">
                        {{admin.showCharts ? 'Hide Analytics' : 'Show Analytics'}}
                    </button>
                    <button ng-click="admin.exportReport()" class="btn btn-primary">Export CSV</button>
                </div>
                <div ng-if="admin.showCharts" class="charts-row">
                    <div class="chart-card"><div id="adminDeptChart"  style="height:300px;"></div></div>
                    <div class="chart-card"><div id="adminStatusPie"  style="height:300px;"></div></div>
                </div>
                <div class="admin-controls">
                    <input type="text" ng-model="admin.searchQuery" placeholder="Search by name or department...">
                    <select ng-model="admin.filterDept">
                        <option value="">All Departments</option>
                        <option ng-repeat="d in admin.departments" value="{{d}}">{{d}}</option>
                    </select>
                    <select ng-model="admin.filterStatus">
                        <option value="">All Status</option>
                        <option value="present">Present</option>
                        <option value="absent">Absent</option>
                        <option value="late">Late</option>
                        <option value="on-leave">On Leave</option>
                    </select>
                </div>
                <div class="hot-wrapper" ng-init="admin.initHandsontable()">
                    <p class="hot-hint">ðŸ’¡ Click any <em>Department</em> or <em>Status</em> cell to edit. Use â–¼ on headers to sort &amp; filter.</p>
                    <div id="employeeHOT"></div>
                </div>
            </div>

            <!-- â”€â”€ Leave Requests Tab â”€â”€ -->
            <div ng-if="admin.activeTab === 'leaves'">
                <div class="admin-controls">
                    <select ng-model="admin.leaveFilterStatus" style="max-width:220px;">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div ng-if="admin.getFilteredLeaves().length === 0" class="empty-state">No leave requests found.</div>
                <div class="leave-cards" ng-if="admin.getFilteredLeaves().length > 0">
                    <div class="leave-card" ng-repeat="l in admin.getFilteredLeaves()" ng-class="'leave-card-' + l.status">
                        <div class="leave-card-header">
                            <div><strong>{{l.employeeName}}</strong><span class="leave-dept-tag">{{l.department}}</span></div>
                            <span ng-class="admin.leaveStatusClass(l.status)">{{l.status}}</span>
                        </div>
                        <div class="leave-card-body">
                            <div class="leave-meta-row">
                                <span class="leave-type-pill">{{l.type}}</span>
                                <span class="leave-dates">{{l.fromDate}} â†’ {{l.toDate}} <strong>({{l.days}} day{{l.days > 1 ? 's' : ''}})</strong></span>
                            </div>
                            <p class="leave-reason">"{{l.reason}}"</p>
                            <p class="leave-applied">Applied: {{l.appliedOn | date:'MMM d, yyyy â€“ HH:mm'}}</p>
                            <p ng-if="l.decidedOn" class="leave-applied">Decision: {{l.decidedOn | date:'MMM d, yyyy â€“ HH:mm'}}</p>
                        </div>
                        <div class="leave-card-actions" ng-if="l.status === 'pending'">
                            <button ng-click="admin.approveLeave(l)" class="btn-approve">âœ“ Approve</button>
                            <button ng-click="admin.rejectLeave(l)"  class="btn-reject">âœ— Reject</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- â”€â”€ Add Employee Tab â”€â”€ -->
            <div ng-if="admin.activeTab === 'add'">
                <div class="add-employee-form">
                    <h3>Create Employee Account</h3>
                    <div class="add-employee-grid">
                        <div class="form-group"><label>Full Name</label><input type="text" ng-model="admin.newEmp.name" placeholder="Full Name"></div>
                        <div class="form-group"><label>Employee ID</label><input type="text" ng-model="admin.newEmp.employeeId" placeholder="e.g. EMP004"></div>
                        <div class="form-group">
                            <label>Department</label>
                            <select ng-model="admin.newEmp.department">
                                <option value="">Select...</option>
                                <option ng-repeat="d in admin.departments" value="{{d}}">{{d}}</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Email</label><input type="email" ng-model="admin.newEmp.email" placeholder="name@djubo.com"></div>
                        <div class="form-group"><label>Password</label><input type="password" ng-model="admin.newEmp.password" placeholder="Initial password"></div>
                    </div>
                    <div class="form-actions" style="margin-top:1.25rem;">
                        <button ng-click="admin.addEmployee()" class="btn btn-primary">Create Account</button>
                    </div>
                </div>
                <div class="empty-state" ng-if="admin.employees.length === 0">No employees yet.</div>
                <div ng-if="admin.employees.length > 0">
                    <p style="margin-bottom:0.75rem; color:#666; font-size:0.875rem;">Existing employees ({{admin.employees.length}})</p>
                    <table class="leave-table">
                        <thead><tr><th>ID</th><th>Name</th><th>Department</th><th>Email</th><th>Joined</th></tr></thead>
                        <tbody>
                            <tr ng-repeat="e in admin.employees">
                                <td>{{e.id}}</td><td>{{e.name}}</td><td>{{e.department}}</td><td>{{e.email}}</td><td>{{e.joined}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Employee detail modal -->
            <div class="modal" ng-if="admin.selectedEmp" ng-click="admin.closeModal()">
                <div class="modal-content" style="max-width:520px;" ng-click="$event.stopPropagation()">
                    <div class="modal-header">
                        <h2>{{admin.selectedEmp.name}}</h2>
                        <button ng-click="admin.closeModal()" class="btn-close">Close</button>
                    </div>
                    <div class="details">
                        <p><strong>Department:</strong> {{admin.selectedEmp.department}}</p>
                        <p><strong>Email:</strong> {{admin.selectedEmp.email}}</p>
                        <p><strong>Attendance Rate:</strong> {{admin.selectedEmp.attendanceRate}}%</p>
                        <p><strong>Present Days:</strong> {{admin.selectedEmp.presentDays}}</p>
                        <p><strong>Joined:</strong> {{admin.selectedEmp.joined}}</p>
                    </div>
                    <div id="employeeSparkline" style="height:200px; margin-top:1rem;"></div>
                </div>
            </div>

        </div><!-- /admin -->
    </div><!-- /main-container -->


    <!-- Profile Modal -->
    <div class="modal" ng-if="main.showProfile" ng-click="main.closeProfile()">
        <div class="modal-content profile-modal" ng-click="$event.stopPropagation()">
            <div class="modal-header">
                <h2>Profile Settings</h2>
                <button ng-click="main.closeProfile()" class="btn-close">Close</button>
            </div>
            <div class="profile-section">
                <div class="profile-picture-section">
                    <div class="profile-picture">
                        <img ng-if="main.profileData.profilePicture" ng-src="{{main.profileData.profilePicture}}" alt="Profile">
                        <div ng-if="!main.profileData.profilePicture" class="profile-placeholder">{{main.profileData.name.charAt(0)}}</div>
                    </div>
                    <input type="file" id="profilePicture" accept="image/*" style="display:none">
                    <button ng-click="main.triggerFileUpload()" class="btn btn-secondary">Change Photo</button>
                </div>
                <form ng-submit="main.saveProfile()">
                    <div class="form-group"><label>Full Name</label><input type="text" ng-model="main.profileData.name" required></div>
                    <div class="form-group"><label>Employee ID</label><input type="text" ng-model="main.profileData.employeeId" disabled></div>
                    <div class="form-group"><label>Email</label><input type="email" ng-model="main.profileData.email" required></div>
                    <div class="form-group"><label>Date of Birth</label><input type="date" ng-model="main.profileData.dob"></div>
                    <div class="form-group">
                        <label>Department</label>
                        <select ng-model="main.profileData.department" required>
                            <option ng-repeat="d in ['Engineering','Marketing','Sales','HR','Finance','Operations']" value="{{d}}">{{d}}</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Phone</label><input type="tel" ng-model="main.profileData.phone" placeholder="+91 XXXXX XXXXX"></div>
                    <div class="form-group"><label>Address</label><textarea ng-model="main.profileData.address" rows="3"></textarea></div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" ng-click="main.closeProfile()" class="btn btn-secondary">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Break Overlay -->
    <div class="break-overlay" ng-if="main.onBreak">
        <div class="break-modal">
            <h2>On Break</h2>
            <div class="break-timer">{{main.breakTimer}}</div>
            <p>Break timer is running</p>
            <button ng-click="main.endBreak()" class="btn btn-primary">End Break</button>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.6/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.js"></script>
    <script src="app.js"></script>
</body>
</html>